<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DespensaBoy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
        sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    button:hover {
      transform: scale(1.02);
    }
    button:active {
      transform: scale(0.98);
    }
    input:focus {
      outline: 2px solid #667eea;
    }
    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 200px;
      padding: 20px;
      gap: 8px;
    }
    .bar-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .bar {
      width: 100%;
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px 8px 0 0;
      transition: all 0.3s;
      min-height: 20px;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 8px;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .bar-label {
      font-size: 11px;
      text-align: center;
      color: #666;
      max-width: 80px;
      word-wrap: break-word;
      line-height: 1.2;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    // Configuraci√≥n de tipos de raciones
    const TIPOS_RACIONES = [
      { tipo: 'Fresco', icono: 'üêüü•©', caducidadMin: 1, caducidadMax: 3, ubicacion: 'nevera' },
      { tipo: 'Refrigerado', icono: 'ü•öüßÄ', caducidadMin: 3, caducidadMax: 14, ubicacion: 'nevera' },
      { tipo: 'Congelado', icono: '‚ùÑÔ∏èüßä', caducidadMin: 90, caducidadMax: 365, ubicacion: 'congelador' },
      { tipo: 'Conserva', icono: 'ü•´', caducidadMin: 365, caducidadMax: 1825, ubicacion: 'despensa' },
      { tipo: 'Conserva en fr√≠o', icono: 'ü´ô', caducidadMin: 30, caducidadMax: 180, ubicacion: 'nevera' },
      { tipo: 'Cereal', icono: 'üçöü´ò', caducidadMin: 180, caducidadMax: 730, ubicacion: 'despensa' },
      { tipo: 'Embutido', icono: 'ü•™', caducidadMin: 30, caducidadMax: 365, ubicacion: 'despensa o nevera' },
      { tipo: 'Precocinado', icono: 'üç≤', caducidadMin: 3, caducidadMax: 30, ubicacion: 'nevera' },
      { tipo: 'Preparado listo para comer', icono: 'üçùü•ó', caducidadMin: 1, caducidadMax: 4, ubicacion: 'nevera' },
      { tipo: 'Boller√≠a / snack', icono: 'üç™üçø', caducidadMin: 90, caducidadMax: 365, ubicacion: 'despensa' },
      { tipo: 'Panader√≠a / reposter√≠a', icono: 'ü•ñüßÅ', caducidadMin: 1, caducidadMax: 5, ubicacion: 'despensa' },
    ];

    const LOCAL_STORAGE_KEY = 'raciones';

    // Utilidades
    const parseDate = (dateStr) => {
      const [day, month, year] = dateStr.split('/').map(Number);
      return new Date(year, month - 1, day);
    };

    const formatDate = (date) => {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    };

    const addDays = (date, days) => {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    };

    const getDaysUntilExpiry = (expiryDate) => {
      const expiry = parseDate(expiryDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      expiry.setHours(0, 0, 0, 0);
      const diffTime = expiry.getTime() - today.getTime();
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    };

    // Estado de la aplicaci√≥n
    let state = {
      screen: 'main',
      raciones: [],
      tempRaciones: [],
      selectedRaciones: [],
      counts: {},
      panelExpanded: false,
      showPopup: false,
      currentTipo: ''
    };

    // Cargar datos
    function loadData() {
      const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
      if (stored) {
        try {
          const data = JSON.parse(stored);
          state.raciones = data.raciones || [];
        } catch (e) {
          console.error('Error loading data:', e);
        }
      }
    }

    // Guardar datos
    function saveData(raciones) {
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ raciones }));
      state.raciones = raciones;
    }

    // Renderizar
    function render() {
      const root = document.getElementById('root');
      
      if (state.screen === 'main') {
        root.innerHTML = renderMain();
      } else if (state.screen === 'registrar') {
        root.innerHTML = renderRegistrar();
      } else if (state.screen === 'consumir') {
        root.innerHTML = renderConsumir();
      } else if (state.screen === 'ver') {
        root.innerHTML = renderVer();
      } else if (state.screen === 'historico') {
        root.innerHTML = renderHistorico();
      }
      
      attachEventListeners();
    }

    // Pantalla principal
    function renderMain() {
      const totalRaciones = state.raciones.length;
      const racionesProximasCaducar = state.raciones.filter(r => {
        const days = getDaysUntilExpiry(r.caducidad);
        return days <= 2 && days >= 0;
      }).length;
      const racionesCaducadas = state.raciones.filter(r => getDaysUntilExpiry(r.caducidad) < 0).length;

      // Calcular datos para gr√°fico
      const counts = {};
      state.raciones.forEach(r => {
        counts[r.tipo] = (counts[r.tipo] || 0) + 1;
      });
      const chartData = Object.entries(counts);
      const maxCount = Math.max(...Object.values(counts), 1);

      return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
          <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h1 style="font-size: 32px; font-weight: bold; color: #333; margin-bottom: 30px; text-align: center;">üçΩÔ∏è DespensaBoy</h1>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px;">
              <div style="padding: 20px; border-radius: 15px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;">${totalRaciones}</div>
                <div style="font-size: 14px; opacity: 0.95;">Raciones disponibles</div>
              </div>
              <div style="padding: 20px; border-radius: 15px; text-align: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;">${racionesProximasCaducar}</div>
                <div style="font-size: 14px; opacity: 0.95;">Pr√≥ximas a caducar</div>
              </div>
              <div style="padding: 20px; border-radius: 15px; text-align: center; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                <div style="font-size: 36px; font-weight: bold; margin-bottom: 5px;">${racionesCaducadas}</div>
                <div style="font-size: 14px; opacity: 0.95;">Caducadas</div>
              </div>
            </div>

            <div style="background: #f9f9f9; border-radius: 15px; padding: 20px; margin-bottom: 30px;">
              <h3 style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 15px;">Distribuci√≥n por tipo</h3>
              ${chartData.length > 0 ? `
                <div class="bar-chart">
                  ${chartData.map(([tipo, count]) => `
                    <div class="bar-item">
                      <div class="bar" style="height: ${(count / maxCount) * 150}px;">${count}</div>
                      <div class="bar-label">${tipo}</div>
                    </div>
                  `).join('')}
                </div>
              ` : '<div style="text-align: center; padding: 40px; color: #999; font-size: 16px;">Comienza registrando una compraüëá</div>'}
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
              <button onclick="goToScreen('registrar')" style="padding: 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                üì¶ Registrar compra
              </button>
              <button onclick="goToScreen('consumir')" style="padding: 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; color: white; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                üç¥ Consumir raciones
              </button>
              <button onclick="goToScreen('ver')" style="padding: 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; color: #333; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                üìã Ver raciones
              </button>
              <button onclick="goToScreen('historico')" style="padding: 20px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; color: #333; background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%);">
                üìä Ver hist√≥rico
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderRegistrar() {
      return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
          <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <button onclick="goToScreen('main')" style="background: #f0f0f0; border: none; padding: 10px 20px; border-radius: 10px; font-size: 16px; cursor: pointer; margin-bottom: 15px; font-weight: 600; color: #555;">‚Üê Volver</button>
            <h2 style="font-size: 26px; font-weight: bold; color: #333; margin-bottom: 25px; margin-top: 10px;">üì¶ Registrar Compra</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
              ${TIPOS_RACIONES.map(config => `
                <button onclick="addTipoRacion('${config.tipo}')" style="position: relative; padding: 20px 10px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center;">
                  <div style="font-size: 32px; margin-bottom: 8px;">${config.icono}</div>
                  <div style="font-size: 13px; font-weight: 600; color: #333; line-height: 1.2;">${config.tipo}</div>
                  ${state.counts[config.tipo] > 0 ? `<div style="position: absolute; top: 8px; right: 8px; background: #667eea; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">${state.counts[config.tipo]}</div>` : ''}
                </button>
              `).join('')}
            </div>

            ${state.tempRaciones.length > 0 ? `
              <div id="panel" style="position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); max-height: ${state.panelExpanded ? '70vh' : '70px'}; overflow-y: auto; z-index: 1000; transition: max-height 0.3s ease;">
                <div onclick="togglePanel()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: 600; color: #333; border-bottom: 1px solid #e0e0e0;">
                  <span>${state.tempRaciones.length} raciones a√±adidas</span>
                  <span>${state.panelExpanded ? '‚ñº' : '‚ñ≤'}</span>
                </div>
                ${state.panelExpanded ? `
                  <div style="padding: 20px;">
                    ${state.tempRaciones.map((racion, index) => {
                      const config = TIPOS_RACIONES.find(t => t.tipo === racion.tipo);
                      return `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px;">
                          <div style="font-size: 28px; flex-shrink: 0;">${config.icono}</div>
                          <div style="flex: 1;">
                            <input type="text" value="${racion.nombre}" onchange="updateRacionNombre(${index}, this.value)" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; margin-bottom: 5px;">
                            <div style="margin-bottom: 5px;">
                              <label style="font-size: 14px; color: #666; display: flex; align-items: center;">
                                Caduca en:
                                <input type="number" value="${racion.caducidad}" onchange="updateRacionCaducidad(${index}, this.value)" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 70px; margin-left: 8px;">
                                d√≠as
                              </label>
                            </div>
                            <div style="font-size: 13px; color: #666;">${config.tipo} ‚Ä¢ ${config.ubicacion}</div>
                          </div>
                          <button onclick="removeRacion(${index})" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer; flex-shrink: 0;">‚úï</button>
                        </div>
                      `;
                    }).join('')}
                    <button onclick="finalizarRegistro()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 15px;">
                      ‚úì Finalizar
                    </button>
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderConsumir() {
      const counts = {};
      TIPOS_RACIONES.forEach(config => {
        counts[config.tipo] = state.raciones.filter(r => r.tipo === config.tipo).length;
      });

      return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
          <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <button onclick="goToScreen('main')" style="background: #f0f0f0; border: none; padding: 10px 20px; border-radius: 10px; font-size: 16px; cursor: pointer; margin-bottom: 15px; font-weight: 600; color: #555;">‚Üê Volver</button>
            <h2 style="font-size: 26px; font-weight: bold; color: #333; margin-bottom: 25px; margin-top: 10px;">üç¥ Consumir Raciones</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;">
              ${TIPOS_RACIONES.map(config => {
                const available = counts[config.tipo] || 0;
                const consumed = state.selectedRaciones.filter(r => r.tipo === config.tipo).length;
                const remaining = available - consumed;
                
                return `
                  <button onclick="selectTipoConsumir('${config.tipo}')" ${remaining === 0 ? 'disabled' : ''} style="position: relative; padding: 20px 10px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border: 2px solid transparent; border-radius: 12px; cursor: pointer; text-align: center; ${remaining === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}">
                    <div style="font-size: 32px; margin-bottom: 8px;">${config.icono}</div>
                    <div style="font-size: 13px; font-weight: 600; color: #333; line-height: 1.2;">${config.tipo}</div>
                    ${remaining > 0 ? `<div style="position: absolute; top: 8px; right: 8px; background: #667eea; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">${remaining}</div>` : ''}
                  </button>
                `;
              }).join('')}
            </div>

            ${state.showPopup ? `
              <div onclick="closePopup()" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 2000;">
                <div onclick="event.stopPropagation()" style="background: white; border-radius: 20px; padding: 25px; max-width: 500px; width: 90%; max-height: 70vh; overflow: auto;">
                  <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #333;">Selecciona una raci√≥n</h3>
                  <div style="margin-bottom: 15px;">
                    ${state.raciones
                      .filter(r => r.tipo === state.currentTipo && !state.selectedRaciones.find(s => s.id === r.id))
                      .map(racion => {
                        const daysLeft = getDaysUntilExpiry(racion.caducidad);
                        const isExpired = daysLeft < 0;
                        const isNearExpiry = daysLeft <= 2 && daysLeft >= 0;
                        
                        return `
                          <button onclick="selectRacion('${racion.id}')" style="width: 100%; padding: 15px; background: ${isExpired ? '#ffe0e0' : isNearExpiry ? '#fff4e0' : '#f9f9f9'}; border: 2px solid ${isExpired ? '#ff4444' : isNearExpiry ? '#ff9944' : 'transparent'}; border-radius: 10px; cursor: pointer; margin-bottom: 10px; text-align: left;">
                            <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">${racion.nombre}</div>
                            <div style="font-size: 14px; color: #666;">
                              Caduca: ${racion.caducidad}
                              ${isExpired ? ' (caducada)' : ''}
                              ${isNearExpiry ? ` (${daysLeft} d√≠as)` : ''}
                            </div>
                          </button>
                        `;
                      }).join('')}
                  </div>
                  <button onclick="closePopup()" style="width: 100%; padding: 12px; background: #f0f0f0; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; color: #555;">Cancelar</button>
                </div>
              </div>
            ` : ''}

            ${state.selectedRaciones.length > 0 ? `
              <div id="panel" style="position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); max-height: ${state.panelExpanded ? '70vh' : '70px'}; overflow-y: auto; z-index: 1000; transition: max-height 0.3s ease;">
                <div onclick="togglePanel()" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 16px; font-weight: 600; color: #333; border-bottom: 1px solid #e0e0e0;">
                  <span>${state.selectedRaciones.length} raciones a consumir</span>
                  <span>${state.panelExpanded ? '‚ñº' : '‚ñ≤'}</span>
                </div>
                ${state.panelExpanded ? `
                  <div style="padding: 20px;">
                    ${state.selectedRaciones.map((racion, index) => {
                      const config = TIPOS_RACIONES.find(t => t.tipo === racion.tipo);
                      return `
                        <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: #f9f9f9; border-radius: 10px; margin-bottom: 10px;">
                          <div style="font-size: 28px; flex-shrink: 0;">${config.icono}</div>
                          <div style="flex: 1;">
                            <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">${racion.nombre}</div>
                            <div style="font-size: 13px; color: #666;">Caduca: ${racion.caducidad} ‚Ä¢ ${config.ubicacion}</div>
                          </div>
                          <button onclick="removeSelectedRacion(${index})" style="background: #ff4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 18px; cursor: pointer; flex-shrink: 0;">‚úï</button>
                        </div>
                      `;
                    }).join('')}
                    <button onclick="finalizarConsumo()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 15px;">
                      ‚úì Finalizar
                    </button>
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderVer() {
      const racionesPorTipo = {};
      state.raciones.forEach(r => {
        if (!racionesPorTipo[r.tipo]) racionesPorTipo[r.tipo] = [];
        racionesPorTipo[r.tipo].push(r);
      });

      Object.keys(racionesPorTipo).forEach(tipo => {
        racionesPorTipo[tipo].sort((a, b) => {
          const dateA = parseDate(a.caducidad);
          const dateB = parseDate(b.caducidad);
          return dateA.getTime() - dateB.getTime();
        });
      });

      return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
          <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <button onclick="goToScreen('main')" style="background: #f0f0f0; border: none; padding: 10px 20px; border-radius: 10px; font-size: 16px; cursor: pointer; margin-bottom: 15px; font-weight: 600; color: #555;">‚Üê Volver</button>
            <h2 style="font-size: 26px; font-weight: bold; color: #333; margin-bottom: 25px; margin-top: 10px;">üìã Ver Raciones</h2>
            
            ${Object.keys(racionesPorTipo).length === 0 ? 
              '<div style="text-align: center; padding: 60px 20px; color: #999; font-size: 16px;">No hay raciones registradas</div>' :
              `<div style="margin-top: 20px;">
                ${TIPOS_RACIONES.map(config => {
                  const racionesTipo = racionesPorTipo[config.tipo];
                  if (!racionesTipo || racionesTipo.length === 0) return '';
                  
                  return `
                    <div style="margin-bottom: 30px;">
                      <h3 style="font-size: 20px; font-weight: 600; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
                        ${config.icono} ${config.tipo} (${racionesTipo.length})
                      </h3>
                      <div style="display: grid; gap: 10px;">
                        ${racionesTipo.map(racion => {
                          const daysLeft = getDaysUntilExpiry(racion.caducidad);
                          const isExpired = daysLeft < 0;
                          const isNearExpiry = daysLeft <= 2 && daysLeft >= 0;
                          
                          return `
                            <div style="padding: 15px; background: ${isExpired ? '#ffe0e0' : isNearExpiry ? '#fff4e0' : '#f9f9f9'}; border-radius: 10px; border-left: 4px solid ${isExpired ? '#ff4444' : isNearExpiry ? '#ff9944' : '#667eea'};">
                              <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">${racion.nombre}</div>
                              <div style="font-size: 14px; color: #666; margin-bottom: 3px;">
                                Caduca: ${racion.caducidad}
                                ${isExpired ? ' ‚ùå' : ''}
                                ${isNearExpiry ? ` ‚ö†Ô∏è (${daysLeft} d√≠as)` : ''}
                              </div>
                              <div style="font-size: 13px; color: #999;">${config.ubicacion}</div>
                            </div>
                          `;
                        }).join('')}
                      </div>
                    </div>
                  `;
                }).join('')}
              </div>`
            }
          </div>
        </div>
      `;
    }

    function renderHistorico() {
      return `
        <div style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px;">
          <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <button onclick="goToScreen('main')" style="background: #f0f0f0; border: none; padding: 10px 20px; border-radius: 10px; font-size: 16px; cursor: pointer; margin-bottom: 15px; font-weight: 600; color: #555;">‚Üê Volver</button>
            <h2 style="font-size: 26px; font-weight: bold; color: #333; margin-bottom: 25px; margin-top: 10px;">üìä Hist√≥rico</h2>
            <p style="text-align: center; padding: 60px 20px; color: #999; font-size: 16px;">Esta funcionalidad se implementar√° m√°s tarde</p>
          </div>
        </div>
      `;
    }

    // Event handlers
    function goToScreen(screen) {
      state.screen = screen;
      state.panelExpanded = false;
      state.showPopup = false;
      if (screen === 'registrar') {
        state.tempRaciones = [];
        state.counts = {};
      } else if (screen === 'consumir') {
        state.selectedRaciones = [];
      }
      render();
    }

    function addTipoRacion(tipo) {
      const config = TIPOS_RACIONES.find(t => t.tipo === tipo);
      const defaultDays = Math.floor((config.caducidadMin + config.caducidadMax) / 2);
      
      state.counts[tipo] = (state.counts[tipo] || 0) + 1;
      state.tempRaciones.push({
        tipo,
        nombre: tipo,
        caducidad: defaultDays
      });
      render();
    }

    function updateRacionNombre(index, value) {
      state.tempRaciones[index].nombre = value;
    }

    function updateRacionCaducidad(index, value) {
      state.tempRaciones[index].caducidad = parseInt(value);
    }

    function removeRacion(index) {
      const racion = state.tempRaciones[index];
      state.counts[racion.tipo] = Math.max(0, (state.counts[racion.tipo] || 1) - 1);
      state.tempRaciones.splice(index, 1);
      render();
    }

    function togglePanel() {
      state.panelExpanded = !state.panelExpanded;
      render();
    }

    function finalizarRegistro() {
      const now = new Date();
      const nuevasRaciones = state.tempRaciones.map(temp => ({
        id: `${Date.now()}-${Math.random()}`,
        nombre: temp.nombre,
        tipo: temp.tipo,
        caducidad: formatDate(addDays(now, temp.caducidad)),
        fechaRegistro: formatDate(now)
      }));
      
      saveData([...state.raciones, ...nuevasRaciones]);
      goToScreen('main');
    }

    function selectTipoConsumir(tipo) {
      state.currentTipo = tipo;
      state.showPopup = true;
      render();
    }

    function selectRacion(id) {
      const racion = state.raciones.find(r => r.id === id);
      if (racion) {
        state.selectedRaciones.push(racion);
      }
      state.showPopup = false;
      render();
    }

    function closePopup() {
      state.showPopup = false;
      render();
    }

    function removeSelectedRacion(index) {
      state.selectedRaciones.splice(index, 1);
      render();
    }

    function finalizarConsumo() {
      const idsToRemove = new Set(state.selectedRaciones.map(r => r.id));
      const remaining = state.raciones.filter(r => !idsToRemove.has(r.id));
      saveData(remaining);
      goToScreen('main');
    }

    function attachEventListeners() {
      // Los eventos ya est√°n inline en el HTML
    }

    // Inicializar
    loadData();
    render();
  </script>
</body>
</html>
